<?php

declare(strict_types=1);

/**
 * Meta Tags Template
 *
 * This file provides functions to generate meta tags for SEO and social sharing.
 * Copy this file to meta.php and customize for your project.
 *
 * Usage:
 *   <?php require_once __DIR__ . '/includes/meta.php'; ?>
 *   <?= renderMetaTags($pageData); ?>
 */

/**
 * Render all meta tags for a page
 *
 * @param array{
 *   title: string,
 *   description: string,
 *   url: string,
 *   image?: string,
 *   type?: string,
 *   siteName?: string,
 *   twitterCard?: string,
 *   twitterSite?: string,
 *   locale?: string,
 *   geo?: array{lat: float, lng: float, placename: string, region: string}
 * } $page Page metadata
 * @return string HTML meta tags
 */
function renderMetaTags(array $page): string
{
    $tags = [];

    // Basic meta tags
    $tags[] = '<meta name="description" content="' . htmlspecialchars($page['description'], ENT_QUOTES, 'UTF-8') . '">';
    $tags[] = '<link rel="canonical" href="' . htmlspecialchars($page['url'], ENT_QUOTES, 'UTF-8') . '">';

    // Open Graph tags
    $tags[] = '';
    $tags[] = '<!-- Open Graph -->';
    $tags[] = '<meta property="og:title" content="' . htmlspecialchars($page['title'], ENT_QUOTES, 'UTF-8') . '">';
    $tags[] = '<meta property="og:description" content="' . htmlspecialchars($page['description'], ENT_QUOTES, 'UTF-8') . '">';
    $tags[] = '<meta property="og:url" content="' . htmlspecialchars($page['url'], ENT_QUOTES, 'UTF-8') . '">';
    $tags[] = '<meta property="og:type" content="' . ($page['type'] ?? 'website') . '">';

    if (isset($page['siteName'])) {
        $tags[] = '<meta property="og:site_name" content="' . htmlspecialchars($page['siteName'], ENT_QUOTES, 'UTF-8') . '">';
    }

    if (isset($page['image'])) {
        $tags[] = '<meta property="og:image" content="' . htmlspecialchars($page['image'], ENT_QUOTES, 'UTF-8') . '">';
        $tags[] = '<meta property="og:image:width" content="1200">';
        $tags[] = '<meta property="og:image:height" content="630">';
    }

    if (isset($page['locale'])) {
        $tags[] = '<meta property="og:locale" content="' . $page['locale'] . '">';
    }

    // Twitter Card tags
    $tags[] = '';
    $tags[] = '<!-- Twitter Card -->';
    $tags[] = '<meta name="twitter:card" content="' . ($page['twitterCard'] ?? 'summary_large_image') . '">';
    $tags[] = '<meta name="twitter:title" content="' . htmlspecialchars($page['title'], ENT_QUOTES, 'UTF-8') . '">';
    $tags[] = '<meta name="twitter:description" content="' . htmlspecialchars($page['description'], ENT_QUOTES, 'UTF-8') . '">';

    if (isset($page['image'])) {
        $tags[] = '<meta name="twitter:image" content="' . htmlspecialchars($page['image'], ENT_QUOTES, 'UTF-8') . '">';
    }

    if (isset($page['twitterSite'])) {
        $tags[] = '<meta name="twitter:site" content="' . $page['twitterSite'] . '">';
    }

    // Geo meta tags (for local SEO)
    if (isset($page['geo'])) {
        $tags[] = '';
        $tags[] = '<!-- Geo Tags -->';
        $tags[] = '<meta name="geo.position" content="' . $page['geo']['lat'] . ';' . $page['geo']['lng'] . '">';
        $tags[] = '<meta name="geo.placename" content="' . htmlspecialchars($page['geo']['placename'], ENT_QUOTES, 'UTF-8') . '">';
        $tags[] = '<meta name="geo.region" content="' . $page['geo']['region'] . '">';
        $tags[] = '<meta name="ICBM" content="' . $page['geo']['lat'] . ', ' . $page['geo']['lng'] . '">';
    }

    return implode("\n    ", $tags);
}

/**
 * Render the page title with site name
 *
 * @param string $pageTitle The page-specific title
 * @param string $siteName The site name
 * @param string $separator The separator between page title and site name
 * @return string Complete title tag
 */
function renderTitle(string $pageTitle, string $siteName, string $separator = ' | '): string
{
    $fullTitle = $pageTitle . $separator . $siteName;

    // Truncate if over 60 characters for SEO
    if (strlen($fullTitle) > 60) {
        $fullTitle = substr($fullTitle, 0, 57) . '...';
    }

    return '<title>' . htmlspecialchars($fullTitle, ENT_QUOTES, 'UTF-8') . '</title>';
}

/**
 * Render favicon and app icon tags
 *
 * @param string $basePath Base path to favicon files (e.g., '/assets/images/')
 * @return string HTML link tags for favicons
 */
function renderFavicons(string $basePath = '/assets/images/'): string
{
    $tags = [];

    $tags[] = '<!-- Favicons -->';
    $tags[] = '<link rel="icon" href="' . $basePath . 'favicon.ico" sizes="any">';
    $tags[] = '<link rel="icon" href="' . $basePath . 'favicon.svg" type="image/svg+xml">';
    $tags[] = '<link rel="apple-touch-icon" href="' . $basePath . 'apple-touch-icon.png">';
    $tags[] = '<link rel="manifest" href="/manifest.json">';

    return implode("\n    ", $tags);
}

/**
 * Render preconnect hints for Google Fonts
 *
 * @return string HTML link tags for preconnect
 */
function renderFontPreconnect(): string
{
    return '<link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>';
}

/**
 * Render complete head section with all meta tags
 *
 * @param array{
 *   title: string,
 *   description: string,
 *   url: string,
 *   image?: string,
 *   siteName: string,
 *   type?: string,
 *   twitterCard?: string,
 *   twitterSite?: string,
 *   locale?: string,
 *   geo?: array{lat: float, lng: float, placename: string, region: string},
 *   faviconPath?: string,
 *   fonts?: string
 * } $config Page configuration
 * @return string Complete meta section HTML
 */
function renderHeadMeta(array $config): string
{
    $output = [];

    // Character encoding and viewport
    $output[] = '<meta charset="UTF-8">';
    $output[] = '<meta name="viewport" content="width=device-width, initial-scale=1.0">';
    $output[] = '';

    // Title
    $output[] = renderTitle($config['title'], $config['siteName']);
    $output[] = '';

    // Meta tags
    $output[] = renderMetaTags($config);
    $output[] = '';

    // Favicons
    $faviconPath = $config['faviconPath'] ?? '/assets/images/';
    $output[] = renderFavicons($faviconPath);
    $output[] = '';

    // Font preconnect
    $output[] = renderFontPreconnect();

    // Google Fonts (if specified)
    if (isset($config['fonts'])) {
        $output[] = '<link href="' . $config['fonts'] . '" rel="stylesheet">';
    }

    return implode("\n    ", $output);
}

/*
 * Example Usage:
 *
 * $pageConfig = [
 *     'title' => 'Family Law Services',
 *     'description' => 'Expert family law services including divorce, custody, and estate planning in Seattle.',
 *     'url' => 'https://smithlaw.com/services',
 *     'image' => 'https://smithlaw.com/images/og-image.jpg',
 *     'siteName' => 'Smith & Associates Law Firm',
 *     'type' => 'website',
 *     'twitterSite' => '@smithlaw',
 *     'locale' => 'en_US',
 *     'geo' => [
 *         'lat' => 47.6062,
 *         'lng' => -122.3321,
 *         'placename' => 'Seattle',
 *         'region' => 'US-WA',
 *     ],
 *     'fonts' => 'https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap',
 * ];
 *
 * <head>
 *     <?= renderHeadMeta($pageConfig); ?>
 *     <link rel="stylesheet" href="/assets/css/main.css">
 * </head>
 */
